name: Deploy Docker Stack with Secrets

on:
  workflow_dispatch:
    inputs:
      env:
        description: 'Target environment (production)'
        required: true
        default: 'production'
      useVault:
        description: 'Use HashiCorp Vault for secrets'
        type: boolean
        default: true
      useSops:
        description: 'Decrypt secrets.sops.yml using SOPS'
        type: boolean
        default: true

jobs:
  deploy:
    name: Deploy stack to remote Docker Swarm manager
    runs-on: ubuntu-latest
    permissions: 
      id-token: write  # Needed for cloud provider auth
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Auth with your cloud provider for SOPS key access
      - name: Configure AWS Credentials
        if: inputs.useSops
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-1  # Adjust for your KMS key region
      
      # Optionally add GCP/Azure auth here if using their KMS
      
      - name: Install SOPS
        if: inputs.useSops
        run: |
          SOPS_VERSION=3.7.3  # Update as needed
          curl -LO "https://github.com/mozilla/sops/releases/download/v${SOPS_VERSION}/sops-v${SOPS_VERSION}.linux.amd64"
          sudo mv sops-v${SOPS_VERSION}.linux.amd64 /usr/local/bin/sops
          sudo chmod +x /usr/local/bin/sops
      
      - name: Decrypt Secrets
        if: inputs.useSops
        run: |
          # Decrypt secrets file
          sops -d secrets.sops.yml > secrets.yml
          
          # Export secrets to env for Docker secret creation
          eval $(yq e '.database.password' secrets.yml | sed 's/^/export DB_PASSWORD=/')
          eval $(yq e '.supabase.service_role_key' secrets.yml | sed 's/^/export SUPABASE_SERVICE_ROLE_KEY=/')
          eval $(yq e '.anthropic.api_key' secrets.yml | sed 's/^/export ANTHROPIC_API_KEY=/')
          eval $(yq e '.jwt.secret' secrets.yml | sed 's/^/export JWT_SECRET=/')
          
          # If using Vault, get credentials
          if [[ "${{ inputs.useVault }}" == "true" ]]; then
            eval $(yq e '.vault.role_id' secrets.yml | sed 's/^/export VAULT_ROLE_ID=/')
            eval $(yq e '.vault.secret_id' secrets.yml | sed 's/^/export VAULT_SECRET_ID=/')
          fi

      # Setup Vault access if requested
      - name: Configure Vault
        if: inputs.useVault
        uses: hashicorp/vault-action@v2
        with:
          url: ${{ secrets.VAULT_ADDR }}
          roleId: ${{ env.VAULT_ROLE_ID }}
          secretId: ${{ env.VAULT_SECRET_ID }}
          # Specify secrets to get and map to env vars
          secrets: |
            secret/data/mcp/db url | DATABASE_URL ;
            secret/data/mcp/supabase service_role_key | SUPABASE_SERVICE_ROLE_KEY ;
            secret/data/mcp/anthropic api_key | ANTHROPIC_API_KEY

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}

      - name: Copy compose file and stack assets to remote
        uses: appleboy/scp-action@v0.1.8
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          port: ${{ secrets.DEPLOY_PORT || '22' }}
          source: |
            compose.prod.yml
            secrets.yml
          target: ${{ secrets.DEPLOY_PATH }}

      - name: Deploy and create secrets on remote
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          port: ${{ secrets.DEPLOY_PORT || '22' }}
          key: ${{ secrets.DEPLOY_SSH_PRIVATE_KEY }}
          envs: DATABASE_URL,SUPABASE_SERVICE_ROLE_KEY,ANTHROPIC_API_KEY,JWT_SECRET,DB_PASSWORD
          script: |
            set -e
            cd ${{ secrets.DEPLOY_PATH }} || exit 1

            # Create Docker secrets (idempotent)
            # From SOPS-decrypted values or Vault
            for secret in \
              "anthropic_api_key:$ANTHROPIC_API_KEY" \
              "supabase_secret_key:$SUPABASE_SERVICE_ROLE_KEY" \
              "db_password:$DB_PASSWORD" \
              "jwt_secret:$JWT_SECRET" \
              "database_url:$DATABASE_URL"
            do
              name="${secret%%:*}"
              value="${secret#*:}"
              
              if [ -n "$value" ]; then
                echo "$value" | docker secret rm "$name" 2>/dev/null || true
                echo "$value" | docker secret create "$name" -
              fi
            done

            # Pull latest images
            docker stack deploy -c compose.prod.yml mcp-stack

            # Show services
            docker service ls

            # Cleanup decrypted secrets
            rm -f secrets.yml

    # Required secrets:
    # - DEPLOY_SSH_PRIVATE_KEY: SSH private key for remote manager
    # - DEPLOY_HOST: Remote host IP/name
    # - DEPLOY_USER: SSH user
    # - DEPLOY_PATH: Remote path for compose file
    # For SOPS:
    # - AWS_ROLE_ARN: Role with KMS key access (if using AWS KMS)
    # For Vault:
    # - VAULT_ADDR: Vault server URL

